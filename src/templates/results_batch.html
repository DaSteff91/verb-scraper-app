{% extends "base.html" %} {% block content %}
<div class="row justify-content-center">
  <div class="col-md-10">
    <!-- 1. HIDDEN DATA CONTAINER (The No-Guessing Fix) -->
    <div id="tasks-json-storage" style="display: none">
      {{ tasks_json | safe }}
    </div>

    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-end mb-4">
      <div>
        <h2 class="mb-0">Batch Scrape Results</h2>
        <p class="text-muted">
          Review your collection before exporting to Anki.
        </p>
      </div>
      <div class="text-end">
        <div class="bg-light p-2 rounded border mb-2 d-inline-block text-start">
          <div class="form-check form-switch m-0">
            <input
              class="form-check-input"
              type="checkbox"
              role="switch"
              id="skipCheck"
              checked
            />
            <label
              class="form-check-label fw-bold small"
              for="skipCheck"
              style="cursor: pointer"
            >
              Skip tu / v√≥s (All)
            </label>
          </div>
        </div>
        <br />
        <button
          onclick="downloadBatchCSV()"
          class="btn btn-success fw-bold px-4"
        >
          Download Combined CSV
        </button>
        <a href="/" class="btn btn-outline-secondary ms-2">New Scrape</a>
      </div>
    </div>

    <!-- Grouped Results Accordion -->
    <div class="accordion shadow-sm" id="batchAccordion">
      {% for item in batch %}
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button
            class="accordion-button collapsed"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapse-{{ loop.index }}"
          >
            <strong class="text-primary fs-5">{{ item.verb }}</strong>
            <span class="text-muted ms-3 small"
              >Mode: {{ item.mode }} | Tense: {{ item.tense }}</span
            >
          </button>
        </h2>
        <div
          id="collapse-{{ loop.index }}"
          class="accordion-collapse collapse"
          data-bs-parent="#batchAccordion"
        >
          <div class="accordion-body bg-light-subtle">
            <table class="table table-hover table-sm mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 30%">Person</th>
                  <th>Conjugation</th>
                </tr>
              </thead>
              <tbody>
                {% for conj in item.conjugations %}
                <tr>
                  <td class="text-muted italic small">
                    {{ conj.person.name }}
                  </td>
                  <td class="fw-bold">{{ conj.value }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% else %}
      <div class="alert alert-info text-center">
        No verbs found in the database for this batch.
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  /**
   * Safe Batch Export using the Hidden Data Container
   */
  function downloadBatchCSV() {
    console.log("Preparing Download...");

    // Read the JSON directly from the hidden DIV content
    const rawData = document.getElementById("tasks-json-storage").textContent;

    try {
      const tasks = JSON.parse(rawData);
      const filename = "{{ filename }}";
      const skip = document.getElementById("skipCheck").checked;

      const basePath = "{{ url_for('main.export_batch_csv') | safe }}";
      const url = new URL(basePath, window.location.origin);

      url.searchParams.append("tasks", JSON.stringify(tasks));
      url.searchParams.append("filename", filename);
      if (skip) {
        url.searchParams.append("skip_tu_vos", "true");
      }

      window.location.href = url.href;
    } catch (e) {
      console.error("Failed to parse batch data:", e);
      alert("Could not process the batch data for download.");
    }
  }
</script>
{% endblock %}
