{% extends "base.html" %} {% block content %}
<div class="row justify-content-center" x-data="scrapeComponent()">
  <div class="col-12 col-lg-10 col-xl-8">
    <!-- Multi-Mode Switch Card -->
    <section
      class="modern-card p-4 mb-4 d-flex align-items-center justify-content-between"
      aria-labelledby="multi-mode-label"
    >
      <div>
        <h2
          id="multi-mode-label"
          class="h6 mb-1 fw-bold text-white text-uppercase"
        >
          Multi-Scraping Mode
        </h2>
        <p class="text-muted small mb-0">
          Aggregate multiple tenses into a single batch
        </p>
      </div>
      <div class="form-check form-switch p-0 m-0">
        <!-- Large, high-contrast switch -->
        <input
          class="form-check-input ms-0"
          type="checkbox"
          id="multiToggle"
          role="switch"
          x-model="multiScrape"
          @change="resetSelections()"
          aria-label="Toggle Multi-Scraping"
        />
      </div>
    </section>

    <!-- Main Form Card -->
    <section class="modern-card p-4 p-md-5 mb-5">
      <form
        method="POST"
        id="scrapeForm"
        x-on:submit="if(multiScrape) { $event.preventDefault(); addToBasket(); }"
      >
        <!-- Dynamically generate hidden inputs for all selections -->
        <template x-for="m in selectedModes" :key="'hidden-mode-' + m">
          <input type="hidden" name="mode" :value="m" />
        </template>

        <template x-for="t in selectedTenses" :key="'hidden-tense-' + t">
          <input type="hidden" name="tense" :value="t" />
        </template>
        <input type="hidden" name="tense" :value="selectedTenses[0]" />
        <input type="hidden" name="filename" :value="filename" />

        <div class="mb-5">
          <label for="verb" class="form-label small text-uppercase mb-3"
            >Portuguese Infinitive</label
          >
          <input
            type="text"
            class="form-control form-control-lg py-3 fs-3"
            id="verb"
            name="verb"
            placeholder="e.g., falar"
            required
            autofocus
            x-model="verb"
          />
        </div>

        <div class="row g-4">
          <!-- Mode Selection -->
          <div class="col-12">
            <fieldset>
              <legend class="small text-uppercase mb-3">
                Grammatical Mode
              </legend>
              <div class="d-flex flex-wrap gap-2">
                <template x-for="m in ['Indicativo', 'Subjuntivo']" :key="m">
                  <button
                    type="button"
                    class="btn btn-pill flex-grow-1 flex-md-grow-0"
                    :class="selectedModes.includes(m) ? 'btn-primary' : 'btn-outline-secondary'"
                    x-text="m"
                    @click="toggleMode(m)"
                    :aria-pressed="selectedModes.includes(m)"
                  ></button>
                </template>
              </div>
            </fieldset>
          </div>

          <!-- Tense Selection -->
          <div class="col-12">
            <fieldset>
              <div
                class="d-flex justify-content-between align-items-end flex-nowrap mb-3"
              >
                <legend class="small text-uppercase m-0 text-nowrap">
                  Tense Selection
                </legend>
                <button
                  type="button"
                  class="btn btn-link btn-sm p-0 text-decoration-none text-white fw-bold text-nowrap ms-2"
                  @click="toggleAllTenses()"
                  x-text="selectedTenses.length === availableTenses.length ? 'Clear All' : 'Select All'"
                ></button>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <template x-for="t in availableTenses" :key="t">
                  <button
                    type="button"
                    class="btn btn-pill flex-grow-1 flex-md-grow-0"
                    :class="selectedTenses.includes(t) ? 'btn-primary' : 'btn-outline-secondary'"
                    @click="toggleTense(t)"
                    x-text="t"
                    :aria-pressed="selectedTenses.includes(t)"
                  ></button>
                </template>
              </div>
            </fieldset>
          </div>
        </div>

        <!-- Footer Action Bar -->
        <div class="mt-5 pt-4 border-top border-secondary">
          <div class="row align-items-center g-4">
            <div class="col-md-7" x-show="!multiScrape" x-transition>
              <label
                for="single-filename"
                class="form-label small text-uppercase mb-2"
                >Export Filename</label
              >
              <div class="input-group">
                <input
                  type="text"
                  id="single-filename"
                  class="form-control"
                  x-model="filename"
                  placeholder="verbs_export"
                />
                <span class="input-group-text">.csv</span>
              </div>
            </div>
            <div :class="multiScrape ? 'col-12' : 'col-md-5'">
              <button type="submit" class="btn btn-primary w-100 py-3">
                <span
                  x-text="multiScrape ? 'Add to Batch' : 'Start Scrape'"
                ></span>
              </button>
            </div>
          </div>
        </div>
      </form>
    </section>

    <!-- Batch List -->
    <section x-show="multiScrape && basket.length > 0" x-transition>
      <h2 class="h6 fw-bold text-uppercase text-white mb-4">Batch Queue</h2>
      <div class="list-group mb-4">
        <template x-for="(task, index) in basket" :key="index">
          <div
            class="list-group-item modern-card border-secondary bg-transparent mb-2 p-3 d-flex justify-content-between align-items-center"
          >
            <div class="text-white">
              <span
                class="fw-bold text-uppercase small"
                x-text="task.verb"
              ></span>
              <span
                class="text-muted small ms-2"
                x-text="task.mode + ' / ' + task.tense"
              ></span>
            </div>
            <div class="btn-group">
              <button
                @click="editTask(index)"
                class="btn btn-sm btn-outline-secondary border-0 me-2"
                aria-label="Edit"
              >
                Edit
              </button>
              <button
                @click="basket.splice(index, 1)"
                class="btn btn-sm text-danger text-uppercase fw-bold border-0"
                aria-label="Remove"
              >
                Remove
              </button>
            </div>
          </div>
        </template>
      </div>

      <div class="modern-card p-4 border-primary">
        <div class="mb-4">
          <label
            for="batch-filename"
            class="form-label small text-uppercase mb-2"
            >Combined Group Filename</label
          >
          <input
            type="text"
            id="batch-filename"
            class="form-control"
            x-model="filename"
          />
        </div>
        <button
          @click="executeBatch()"
          :disabled="isProcessing"
          class="btn btn-primary btn-lg w-100 py-3"
        >
          <span x-show="!isProcessing">Process Batch Items</span>
          <span
            x-show="isProcessing"
            class="spinner-border spinner-border-sm"
            aria-hidden="true"
          ></span>
        </button>
      </div>
    </section>
  </div>
</div>

<script>
  function scrapeComponent() {
    return {
      multiScrape: false,
      isProcessing: false,
      basket: [],
      verb: "",
      filename: "verbs_export",
      selectedModes: ["Indicativo"],
      selectedTenses: ["Presente"],
      mapping: {
        Indicativo: [
          "Presente",
          "Pretérito Imperfeito",
          "Pretérito Perfeito",
          "Pretérito Mais-que-perfeito",
          "Futuro do Presente",
          "Futuro do Pretérito",
        ],
        Subjuntivo: ["Presente", "Pretérito Imperfeito", "Futuro"],
      },
      get availableTenses() {
        let tenses = new Set();
        this.selectedModes.forEach((m) => {
          if (this.mapping[m]) this.mapping[m].forEach((t) => tenses.add(t));
        });
        return Array.from(tenses);
      },
      toggleMode(m) {
        if (this.selectedModes.includes(m)) {
          if (this.selectedModes.length > 1) {
            this.selectedModes = this.selectedModes.filter((i) => i !== m);
          }
        } else {
          this.selectedModes.push(m);
        }
        this.selectedTenses = this.selectedTenses.filter((t) =>
          this.availableTenses.includes(t),
        );
      },
      toggleTense(t) {
        if (this.selectedTenses.includes(t)) {
          if (this.selectedTenses.length > 1) {
            this.selectedTenses = this.selectedTenses.filter((i) => i !== t);
          }
        } else {
          this.selectedTenses.push(t);
        }
      },
      toggleAllTenses() {
        this.selectedTenses.length === this.availableTenses.length
          ? (this.selectedTenses = [])
          : (this.selectedTenses = [...this.availableTenses]);
      },
      resetSelections() {
        this.selectedModes = ["Indicativo"];
        this.selectedTenses = ["Presente"];
        this.filename = this.multiScrape
          ? "verbs_batch_export"
          : "verbs_export";
      },
      addToBasket() {
        const verbClean = this.verb.trim().toLowerCase();
        if (!verbClean) return;
        this.selectedModes.forEach((m) => {
          this.selectedTenses.forEach((t) => {
            if (this.mapping[m].includes(t)) {
              if (
                !this.basket.some(
                  (i) => i.verb === verbClean && i.mode === m && i.tense === t,
                )
              ) {
                this.basket.push({ verb: verbClean, mode: m, tense: t });
              }
            }
          });
        });
        this.verb = "";
      },
      editTask(index) {
        const task = this.basket[index];
        this.verb = task.verb;
        this.selectedModes = [task.mode];
        this.selectedTenses = [task.tense];
        this.basket.splice(index, 1);
      },
      async executeBatch() {
        if (this.basket.length === 0 || this.isProcessing) return;
        this.isProcessing = true;
        try {
          const response = await fetch("/batch-scrape", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              filename: this.filename || "batch_export",
              tasks: this.basket,
            }),
          });
          const result = await response.json();
          if (response.ok) window.location.href = result.redirect_url;
          else {
            alert("Error: " + result.error);
            this.isProcessing = false;
          }
        } catch (error) {
          alert("Connection Error");
          this.isProcessing = false;
        }
      },
    };
  }
</script>
{% endblock %}
